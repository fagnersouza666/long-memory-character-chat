flowchart TD
    A[Usuário acessa o sistema] --> B{Primeira vez?}
    
    %% Login/Registro
    B -->|Sim| C[Tela de registro/convite]
    B -->|Não| D[Tela de login]
    C --> E[Preenche dados + define senha]
    E --> F[Email de confirmação]
    F --> D
    
    D --> G[Insere credenciais]
    G --> H{Autenticação válida?}
    H -->|Não| I[Mensagem de erro]
    I --> D
    
    %% Seleção de Organização e Workspace
    H -->|Sim| J{Múltiplas organizações?}
    J -->|Sim| K[Selecionar organização]
    J -->|Não| L{Múltiplos workspaces?}
    K --> L
    
    L -->|Sim| M[Dashboard de workspaces disponíveis]
    L -->|Não| N[Acesso direto ao workspace único]
    M --> O[Selecionar workspace específico]
    O --> N
    
    %% Onboarding para novos Tenant Admins
    N --> P{É Tenant Admin + primeira vez?}
    P -->|Sim| Q[Wizard de Configuração]
    P -->|Não| R[Dashboard principal do workspace]
    
    Q --> Q1[Passo 1: Configurar organização]
    Q1 --> Q2[Passo 2: Criar primeiro workspace]
    Q2 --> Q3[Passo 3: Convidar primeiros usuários]
    Q3 --> Q4[Passo 4: Tutorial das funcionalidades]
    Q4 --> Q5[Opção: Pular tutorial?]
    Q5 -->|Não| Q6[Tutorial interativo]
    Q5 -->|Sim| R
    Q6 --> R
    
    %% Dashboard Principal
    R --> S[Interface contextualizada por workspace]
    S --> T{Ação do usuário}
    
    %% Gestão de Documentos
    T -->|Upload documento| U[Arrastar arquivo ou selecionar]
    U --> U1[Validar tipo/tamanho]
    U1 --> U2{Arquivo válido?}
    U2 -->|Não| U3[Exibir erro + limitações]
    U3 --> U
    U2 -->|Sim| U4[Iniciar upload assíncrono]
    U4 --> U5[Mostrar barra de progresso]
    U5 --> U6[Processamento em background]
    U6 --> U7[Status: Processing]
    U7 --> U8{Processamento concluído?}
    U8 -->|Erro| U9[Status: Error + mensagem]
    U8 -->|Sucesso| U10[Status: Completed]
    U9 --> U11[Opção: Tentar novamente]
    U10 --> U12[Documento disponível para busca]
    U11 --> U4
    U12 --> T
    
    %% Busca Híbrida
    T -->|Fazer busca| V[Campo de busca inteligente]
    V --> V1[Selecionar modo de busca]
    V1 --> V2{Modo selecionado}
    V2 -->|Semântica| V3[Configurar busca vetorial]
    V2 -->|Palavra-chave| V4[Configurar full-text search]
    V2 -->|Híbrida| V5[Configurar busca combinada]
    
    V3 --> V6[Aplicar filtros opcionais]
    V4 --> V6
    V5 --> V6
    
    V6 --> V7[Filtros: Workspace, Tipo, Data, Autor]
    V7 --> V8[Executar busca]
    V8 --> V9[Mostrar indicador de carregamento]
    V9 --> V10{Resultados encontrados?}
    V10 -->|Não| V11[Mensagem: Nenhum resultado]
    V10 -->|Sim| V12[Exibir resultados ranqueados]
    
    V11 --> V13[Sugestões de refinamento]
    V13 --> V6
    
    V12 --> V14[Resultado com score de relevância]
    V14 --> V15[Separação: Match Semântico vs Exato]
    V15 --> V16[Citações clicáveis com fontes]
    V16 --> V17{Usuário clica em fonte?}
    V17 -->|Sim| V18[Abrir documento original]
    V17 -->|Não| V19[Continuar navegando resultados]
    V18 --> V19
    V19 --> T
    
    %% Chat/Conversa
    T -->|Iniciar conversa| W[Nova conversa ou continuar existente]
    W --> W1{Conversa existente?}
    W1 -->|Sim| W2[Carregar histórico da conversa]
    W1 -->|Não| W3[Criar nova conversa]
    W2 --> W4[Interface de chat]
    W3 --> W4
    
    W4 --> W5[Usuário digita pergunta]
    W5 --> W6[Sistema processa com contexto RAG]
    W6 --> W7[Busca documentos relevantes]
    W7 --> W8[Gera resposta com LLM + citações]
    W8 --> W9[Exibe resposta com fontes]
    W9 --> W10[Salva mensagem na conversa]
    W10 --> W11{Continuar conversa?}
    W11 -->|Sim| W5
    W11 -->|Não| T
    
    %% Avaliações (apenas usuários autorizados)
    T -->|Acessar avaliações| X{Permissão para avaliações?}
    X -->|Não| X1[Mensagem: Acesso negado]
    X1 --> T
    X -->|Sim| X2[Dashboard de avaliações]
    X2 --> X3{Ação na avaliação}
    X3 -->|Criar nova| X4[Formulário de avaliação]
    X3 -->|Visualizar| X5[Lista de avaliações do workspace]
    X3 -->|Editar| X6[Editar avaliação existente]
    
    X4 --> X7[Selecionar funcionário]
    X7 --> X8[Preencher critérios e feedback]
    X8 --> X9[Definir metas e score]
    X9 --> X10[Salvar avaliação]
    X10 --> X2
    
    X5 --> X11[Filtrar por período/funcionário]
    X11 --> X12[Visualizar detalhes]
    X12 --> X2
    
    X6 --> X8
    
    %% Painel de Custos
    T -->|Visualizar custos| Y{Permissão para custos?}
    Y -->|Não| Y1[Mensagem: Acesso limitado]
    Y1 --> T
    Y -->|Sim| Y2[Dashboard de custos em tempo real]
    Y2 --> Y3[Gasto atual vs limite mensal]
    Y3 --> Y4[Breakdown por serviço]
    Y4 --> Y5[Breakdown por workspace]
    Y5 --> Y6[Projeção mensal]
    Y6 --> Y7{Alertas ativos?}
    Y7 -->|Sim| Y8[Exibir alertas de custo]
    Y7 -->|Não| Y9[Status: Dentro do orçamento]
    Y8 --> Y10[Opções: Ajustar limites]
    Y9 --> Y10
    Y10 --> T
    
    %% Administração (apenas admins)
    T -->|Área administrativa| Z{É admin?}
    Z -->|Não| Z1[Acesso negado]
    Z1 --> T
    Z -->|Tenant Admin| Z2[Painel Tenant Admin]
    Z -->|Super Admin| Z3[Painel Super Admin]
    Z -->|Workspace Admin| Z4[Painel Workspace Admin]
    
    %% Painel Tenant Admin
    Z2 --> Z5{Ação administrativa}
    Z5 -->|Usuários| Z6[Gerenciar usuários da organização]
    Z5 -->|Workspaces| Z7[Gerenciar workspaces]
    Z5 -->|Limites| Z8[Configurar limites e políticas]
    Z5 -->|Relatórios| Z9[Relatórios de uso organizacional]
    Z5 -->|Auditoria| Z10[Logs de auditoria]
    
    Z6 --> Z11[CRUD de usuários]
    Z11 --> Z12[Atribuir roles e workspaces]
    Z12 --> Z2
    
    Z7 --> Z13[CRUD de workspaces]
    Z13 --> Z14[Configurar isolamento]
    Z14 --> Z2
    
    Z8 --> Z15[Limites de custo por workspace]
    Z15 --> Z16[Rate limiting por usuário]
    Z16 --> Z2
    
    Z9 --> Z17[Métricas de produtividade]
    Z17 --> Z18[Análise de custos detalhada]
    Z18 --> Z2
    
    Z10 --> Z19[Filtrar logs por ação/usuário]
    Z19 --> Z20[Exportar relatórios]
    Z20 --> Z2
    
    %% Painel Super Admin
    Z3 --> Z21{Ação super admin}
    Z21 -->|Tenants| Z22[Gerenciar todas organizações]
    Z21 -->|Sistema| Z23[Métricas de saúde do sistema]
    Z21 -->|Custos| Z24[Custos globais por provider]
    Z21 -->|Modelos| Z25[Configurar modelos disponíveis]
    
    Z22 --> Z26[Status e limites dos tenants]
    Z26 --> Z3
    
    Z23 --> Z27[Uptime e performance]
    Z27 --> Z28[Workers ativos]
    Z28 --> Z29[Alertas do sistema]
    Z29 --> Z3
    
    Z24 --> Z30[Breakdown OpenAI/Anthropic/etc]
    Z30 --> Z31[Top tenants por uso]
    Z31 --> Z3
    
    Z25 --> Z32[Ativar/desativar modelos]
    Z32 --> Z33[Configurar custos por token]
    Z33 --> Z3
    
    %% Painel Workspace Admin
    Z4 --> Z34{Ação workspace admin}
    Z34 -->|Membros| Z35[Gerenciar membros do workspace]
    Z34 -->|Documentos| Z36[Gestão avançada de documentos]
    Z34 -->|Configurações| Z37[Configurações do workspace]
    
    Z35 --> Z38[Adicionar/remover membros]
    Z38 --> Z39[Definir roles no workspace]
    Z39 --> Z4
    
    Z36 --> Z40[Organizar documentos em categorias]
    Z40 --> Z41[Definir permissões por documento]
    Z41 --> Z4
    
    Z37 --> Z42[Configurar busca padrão]
    Z42 --> Z43[Definir templates de avaliação]
    Z43 --> Z4
    
    %% Configurações do Usuário
    T -->|Configurações| AA[Painel de configurações pessoais]
    AA --> AA1[Alterar senha]
    AA1 --> AA2[Preferências de notificação]
    AA2 --> AA3[Configurar idioma/timezone]
    AA3 --> AA4[Histórico de atividades]
    AA4 --> T
    
    %% Logout
    T -->|Logout| BB[Encerrar sessão]
    BB --> CC[Limpar tokens]
    CC --> DD[Redirecionar para login]
    DD --> D
    
    %% Rate Limiting e Controles
    U4 -.-> RL1{Rate limit upload?}
    RL1 -->|Sim| RL2[Exibir limite atingido]
    RL2 --> RL3[Mostrar reset time]
    RL3 --> U
    
    V8 -.-> RL4{Rate limit query?}
    RL4 -->|Sim| RL5[Exibir limite atingido]
    RL5 --> RL6[Mostrar reset time]
    RL6 --> V
    
    W6 -.-> RL7{Rate limit chat?}
    RL7 -->|Sim| RL8[Exibir limite atingido]
    RL8 --> RL9[Mostrar reset time]
    RL9 --> W4
    
    %% Monitoramento de Custos em Tempo Real
    V8 -.-> COST1[Calcular custo da query]
    COST1 -.-> COST2[Atualizar dashboard]
    W8 -.-> COST3[Calcular custo do chat]
    COST3 -.-> COST2
    U6 -.-> COST4[Calcular custo do embedding]
    COST4 -.-> COST2
    
    %% Sistema de Notificações
    COST2 -.-> NOTIF1{Próximo do limite?}
    NOTIF1 -->|Sim| NOTIF2[Enviar alerta]
    NOTIF2 -.-> Y8
    
    %% Classes de estilo
    classDef startEnd fill:#e1f5fe
    classDef decision fill:#fff3e0
    classDef process fill:#e8f5e8
    classDef error fill:#ffebee
    classDef admin fill:#f3e5f5
    classDef cost fill:#fff8e1
    
    class A,DD startEnd
    class B,H,J,L,P,Q5,T,U2,U8,V2,V10,V17,W1,W11,X,X3,Y,Y7,Z,Z5,Z21,Z34 decision
    class G,V8,W6,U6,Z11,Z13,Z15,Z17,Z19,Z26,Z27,Z30,Z32,Z38,Z40,Z42 process
    class I,U3,U9,X1,Y1,Z1 error
    class Z2,Z3,Z4,Z22,Z23,Z24,Z25 admin
    class Y2,Y3,Y4,Y5,Y6,COST1,COST2,COST3,COST4 cost